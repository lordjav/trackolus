{% extends "layout.html" %}

{% block main %}

<form id="purchase-form" method="POST">
    <div id="name-id">
        <input type="text" class="form" id="client-name" name="client-name" autofocus autocomplete="off" placeholder="Client" required hx-get="{{ url_for('get_client') }}" hx-trigger="keyup changed delay:500ms" hx-target="#suggestions2" hx-ext="suggestions">
        <div id="suggestions2"></div>
        <input type="text" class="form" id="client-id" name="client-id" autocomplete="off" placeholder="Identification" required>
    </div>
    <div id="phone-email">
        <input type="text" class="form" id="client-phone" name="client-phone" autocomplete="off" placeholder="Contact phone" required>
        <input type="email" class="form" id="client-email" name="client-email" autocomplete="off" placeholder="E-mail" required>
    </div>
    <br>
    <div class="search-container" id="search-box-2">
        <input list="products" class="form" id="search2" placeholder="Search by SKU code or name" autocomplete="off">
        <datalist id="products">
            {% for product in inventory %}
            <option value="{{ product['SKU'] }} - {{ product['product_name'] }}">Available: {{ product['quantity'] }} items</option>
            {% endfor %}
        </datalist>
        <p id="error-output" style="color:red;">Ya se encuentra en lista</p>
    </div>    
    <div>
        <div class="p-2">
            <table class="table table-striped table-secondary table-borderless" id="purchase-cart">
                <thead class="table-light" id="table-header">
                    <tr>
                        <th>SKU</th>
                        <th>Product name</th>
                        <th>Quantity</th>
                        <th>Price (unit)</th>
                        <th>Total price</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                <tbody id="product-list">
                </tbody>
            </table>
        </div>
    </div>
    <select id="products-selected" name="products-selected" multiple></select>
    <div id="buttons-purchase-container">        
        <button type="submit" onclick="getPDF()" class="menu-button purchase-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="33" height="33" viewBox="0 0 24 24"><g fill="none" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M5 12V5a2 2 0 0 1 2-2h7l5 5v4M5 18h1.5a1.5 1.5 0 0 0 0-3H5v6m12-3h2m1-3h-3v6m-6-6v6h1a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2z"/></g></svg>
            View PDF
        </button>
        <button type="submit" onclick="saveOrder()" class="menu-button purchase-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="33" height="33" viewBox="0 0 24 24"><g fill="none" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 0-4 0"/><path d="M12.5 17H6V3H4"/><path d="m6 5l14 1l-.86 6.017M16.5 13H6m10 6h6m-3-3v6"/></g></svg>
            Save order
        </button>
    </div>
</form>

<script>
  //Retrieve client data if client is in database
  document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.elt.classList.contains('item_name') && event.detail.successful) {      
      var data = JSON.parse(event.detail.xhr.responseText);      
      for (var key in data[0]) {
        if (data[0].hasOwnProperty(key)) {
          var el = document.getElementById(key);
          if (el) {
            el.value = data[0][key];
          }
        }
      }
    }
  });

  // Show suggestions box if client-name input is focused and hide if doesn't
  let clientNameInput = document.getElementById('client-name');
  let suggestions2 = document.getElementById('suggestions2');
  
  clientNameInput.addEventListener('focus', function () {
    suggestions2.style.visibility = 'visible';
  });

  clientNameInput.addEventListener('blur', function () {
    setTimeout(function() {
      suggestions2.style.visibility = 'hidden';
    }, 150)
  });

  //Add product in a new row
  let myInventory = {{ inventory | tojson | safe }};
  function eraseErrorMessage() {
    document.getElementById("error-output").style.visibility = "hidden";
  }
  document.getElementById('search2').addEventListener('input', function(e) {
    let selectedOption = e.target.value;
    let SKU = selectedOption.slice(0, 8);
    if (document.getElementById(SKU) != null) {
        document.getElementById("error-output").style.visibility = "visible";
        setTimeout(eraseErrorMessage, 5000);
    } else {
      let product = myInventory.find(object => object.SKU === SKU);
      let productAdded = document.getElementById("product-list").insertRow();
      productAdded.classList.add('product-to-add');
      const cellClass = ['SKU', 'product', 'quantity', 'unit-price', 'total-price', 'deleteButton'];
      const cellContent = [
        product.SKU, 
        product.product_name, 
        `<input type="number" name="${product.SKU}" class="purchase-quantity" value="1" min="1" max="${product.quantity}">`, 
        product.sell_price,
        product.sell_price,
        '&#x1F5D9;'
      ];
      for (let i = 0; i < 6; i++) {
        let newCell = productAdded.insertCell();
        newCell.classList.add(cellClass[i]);
        newCell.innerHTML = cellContent[i];
        if (i === 5) {
            newCell.classList.add('delete-button');
        }
      }
      /*document.getElementById("product-list").innerHTML += `
        <tr>
            <td>${product.SKU}</td>
            <td>${product.product_name}</td>
            <td><input type="number" class="purchase-quantity" name="${product.SKU}" value="1" min="1" max="${product.quantity}"></td>
            <td>${product.sell_price}</td>
            <td class="total-price">${product.sell_price}</td>
            <td class="delete-button">&#x1F5D9;</td>
        </tr>
      `;*/
      document.getElementById("table-header").style.visibility = "visible";
      document.getElementById("products-selected").innerHTML += `<option id="${product.SKU}" value="${product.SKU}" selected></option>`;
    }
    document.getElementById('search2').value = "";
  });
  
  //Delete product (from hidden input list and table)
  function deleteRow(e) {
    if (e.target.classList.contains("delete-button")) {
      document.getElementById(e.target.parentNode.firstElementChild.innerHTML).remove();
      e.target.closest("tr").remove();
    }
    if (document.querySelectorAll("tr").length == 1) {
        document.getElementById("table-header").style.visibility = "hidden";
    }
  }
  document.querySelector("table").addEventListener("click", deleteRow);
  
  //Dynamically multiply quantity by price
  function updatePrice(e) {
    if (e.target.classList.contains("purchase-quantity")) {
      let total_price = e.target.value * parseInt(e.target.parentNode.nextElementSibling.innerHTML);
      e.target.parentNode.nextElementSibling.nextElementSibling.innerHTML = total_price;
    }    
  }
  document.querySelector("table").addEventListener("input", updatePrice);

  //Generate purchase order as pdf
  form = document.getElementById("purchase-form")
  function getPDF() {
    form.action = "/view_pdf";
    form.target = "_blank";
  }
  
  //Save order in transaction list
  function saveOrder() {
    form.action = "/purchase_order";
    form.target = "_self";
  }
</script>
{% endblock %}